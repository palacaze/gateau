# Gateau CMake Modules

*Gateau* consists in a set of CMake modules that make working with CMake both
easier and safer.

It has been designed as a pragmatic tool to quickly create a working CMake
configuration for C++ projects. As such, it is quite opinionated and equipped to
handle the situations I commonly encounter. However, it may not be able to cope
with random project layouts and unusual or complex needs.

This tool is currently being used to build C++ software, mostly on GNU/Linux,
sometimes on MS Windows, using the GCC, Clang and MinGW compilers. Help will be
needed to improve compatibility with other systems and compilers.

## Features

Gateau aims to simplify the definition of the CMake configuration for your
project. To paraphrase a famous book title, It does so by automating the boring
stuff, and choosing sane defaults so you don't need to.

It contains a few functions, macros and configuration variables that make it
very simple to create an installable project with external dependencies, a few
targets, unit test and some documentation.

In particular it is capable of:

- Setting up useful options to make c++ development convenient:
  - Sane compiler options,
  - Sanitizers integration,
  - LTO, ccache use...
- Looking for dependencies, downloading and compiling for you if missing,
- Declaring new targets that will be configured in a sensible way for you to
  make it both installable and importable by other projects. An export header
  and version header get generated for every target.
- Making targets trivially installable, with automatic installation of binaries,
  headers as well as generation of CMake config, version and target modules so
  that your project can be found and used by other projects.
- Declaring tests in a simple way,
- Automatically generating Doxygen documentation,
- Generating translation files for Qt based projects.

Again, it is a simple tool, not a full-fledge package manager.

## Requirements

### CMake

Only CMake is needed. Version 3.15 or later is mandatory, as Gateau modules
rely on modern CMake constructs to achieve its goals.

### Project organization

The project layout on the file system is not imposed but it is recommended to
organize public headers in the same way you want them installed. That way it will
be possible to automate installation.

A possible layout is the following:

```
Project
├── CMakeLists.txt
├── data/
│  └── Misc.svg
├── doc/
├── example/
│  ├── CMakeLists.txt
│  ├── Example1.cpp
│  └── Example2.cpp
├── README.md
├── src/
│  └── Project/
│     └── Target/
│        ├── CMakeLists.txt
│        ├── File.h
│        ├── File.cpp
│        └── PublicHeader1.h
│        └── PublicHeader2.h
└── test/
   ├── CMakeLists.txt
   ├── Test1.cpp
   └── Test2.cpp
```

This makes it possible to `#include <Project/Target/PublicHeader1.h>` from any
other public header. The singular `test` and `example` directories make it
possible to defined idiomatic `tests` and `examples` CMake targets.


Another popular layout is to put the public headers in the `include` directory:

```
Project
├── CMakeLists.txt
├── include/
│  └── Project/
│     └── Target/
│        ├── CMakeLists.txt
│        └── PublicHeader1.h
│        └── PublicHeader2.h
├── README.md
├── src/
   └── Target/
      ├── CMakeLists.txt
      ├── File.h
      ├── File.cpp
```

*Gateau* can be customized to look for public headers from other base directories,
chances are that you current project layout can be handled easily.

## Tutorial

## User Manual

The Gateau.cmake module is the main entry point of Gateau's CMake modules
distribution. It should be included right after the call project() command, near
the top of a project's top level CMakeLists.txt.

All the other modules are included from this one, so no other inclusion is
necessary.

CMake version 3.15 or later is required.

### Configuration and user visible options

After inclusion of Gateau's main module, a number of cache variables get defined.
They can be categorized into 4 different groups:

- Internal variables used by *Gateau* itself,
- Variables that describe the system,
- Hidden variables used to setup low-level aspects of a *Gateau*-based project,
- User-visible variables that can be used to tweak the configuration of a project.

Each variable is prefixed with an identifier created from the project name. The
identifier is obtained by separating the words of the project name and producing
an all-caps C identifier equivalent string of it. For instance:

| Project Name | Equivalent Prefix |
|--------------|-------------------|
| myproj       | MYPROJ            |
| my-proj      | MY_PROJ           |
| Myproj       | MYPROJ            |
| MyProj       | MY_PROJ           |
| my_proj      | MY_PROJ           |

This prefix identifier is stored in the `PROJECT_IDENT` cache variable.

Here is a breakdown of the variables generated by *Gateau*, by type

#### Informative variables

Those are conceptually read-only.

| Variable      | Description                                    | Value     |
|---------------|------------------------------------------------|-----------|
| PROJECT_IDENT | The identifier string used to prefix variables | ${ID}     |
| ${ID}_ARCH    | The architecture pointer size                  | 32 or 64  |
| ${ID}_X32     | Is this a 32 bits build                        | ON or OFF |
| ${ID}_X64     | Is this a 64 bits build                        | ON or OFF |

#### Low-level configuration variables

Those are meant for the project developers.

| Variable                    | Description                                       | Default                        |
|-----------------------------|---------------------------------------------------|--------------------------------|
| ${ID}_RELATIVE_HEADERS_DIRS | Dirs where headers are expected to be found       | src;include;Src;Source;Include |
| ${ID}_GENERATED_HEADER_CASE | How to name generated headers (CAMEL/SNAKE/HYPEN) | CAMEL                          |
| ${ID}_GENERATED_HEADER_EXT  | Extension of generated healers                    | "h"                            |
| ${ID}_C_STANDARD            | The C standard to use                             | c_std_99                       |
| ${ID}_CXX_STANDARD          | The C++ standard to use                           | cxx_std_17                     |

`${ID}_RELATIVE_HEADERS_DIRS` can be used to teach *Gateau* about the project layout,
and will be used to install the project's development headers correctly.

`${ID}_GENERATED_HEADER_CASE` and `${ID}_GENERATED_HEADER_EXT` and describes
how one wishes the generated headers to be named. Right now, two header
files may be generated for a given target: a version header and an export
header.

| Case   | Result           |
|--------|------------------|
| CAMEL  | TargetVersion.h  |
| SNAKE  | target_version.h |
| HYPHEN | target-version.h |

#### Options and cache variables

The following variables can be set by the user to tweak how the project will be
configured and built. They can grouped thematically.

##### Options that control what gets built

The `${ID}_BUILD_XXXX` options can be used by the project developer to selectively
deactivate parts of the project to be built.

| Option                 | Description         | Default |
|------------------------|---------------------|---------|
| ${ID}_BUILD_EXAMPLES   | Build code examples | ON      |
| ${ID}_BUILD_TESTS      | Build tests         | ON      |
| ${ID}_BUILD_DOC        | Build documentation | ON      |
| ${ID}_BUILD_BENCHMARKS | Build benchmarks    | OFF     |

##### Options that affect the compilation

A number of options can be used to change the compiler flags.

| Option                         | Description                                                   | Default    |
|--------------------------------|---------------------------------------------------------------|------------|
| ${ID}_ENABLE_AUTOSELECT_LINKER | Select the best available linker                              | ON         |
| ${ID}_ENABLE_COMMON_WARNINGS   | Enable common compiler flags                                  | ON         |
| ${ID}_ENABLE_LIBCXX            | Use libc++ instead of gcc standard library                    | OFF        |
| ${ID}_ENABLE_LTO               | Enable link time optimization (release only)                  | OFF        |
| ${ID}_ENABLE_MANY_WARNINGS     | Enable more compiler warnings                                 | OFF        |
| ${ID}_ENABLE_PROFILING         | Add compile flags to help with profiling                      | OFF        |
| ${ID}_SANITIZE_ADDRESS         | Compile with address sanitizer support                        | OFF        |
| ${ID}_SANITIZE_THREADS         | Compile with thread sanitizer support                         | OFF        |
| ${ID}_SANITIZE_UNDEFINED       | Compile with undefined sanitizer support                      | OFF        |
| ${ID}_KEEP_TEMPS               | Keep temporary compiler-generated files for debugging purpose | OFF        |
| ${ID}_USE_CCACHE               | Use Ccache to speed-up compilation                            | OFF        |

##### Options that control where build artifacts get stored

BD = PROJECT_BINARY_DIR

| Option                   | Description                               | Default   |
|--------------------------|-------------------------------------------|-----------|
| ${ID}_OUTPUT_DIRECTORY   | Where to place compiled targets           | ""        |
| ${ID}_DOCUMENTATION_ROOT | Documentation installation root directory | ${BD}/doc |

##### Options that control how external dependencies are build

Gateau has limited ability to install missing external dependencies. This feature
can be disabled with the `${ID}_NO_INSTALL_DEPS` option. At the other side of the
spectrum, `${ID}_UPDATE_DEPS` can be used to instruct Gateau to update external
dependencies. This is useful for projects that rely on multiple related third
party components highly coupled but managed in distinct repositories.

The other options are meant to tweak external dependencies handling.

| Option                        | Description                                                   | Default                |
|-------------------------------|---------------------------------------------------------------|------------------------|
| ${ID}_NO_BUILD_DEPS           | Prevent Gateau from building missing external dependencies    | OFF                    |
| ${ID}_UPDATE_DEPS             | Update the external packages when the project is reconfigured | OFF                    |
| ${ID}_EXTERNAL_ROOT           | Root directory where external packages get handled            | ${BD}/external         |
| ${ID}_EXTERNAL_BUILD_TYPE     | Build type used to build external packages                    | Release                |
| ${ID}_EXTERNAL_INSTALL_PREFIX | Prefix where to install built external packages               | EXTERNAL_ROOT/prefix   |
| ${ID}_DOWNLOAD_CACHE          | Directory that acts as a download cache for external packages | EXTERNAL_ROOT/download |

### Project creation

### Finding dependencies

### Creating targets

### Installing a project

### Generating documentation

### Adding tests
